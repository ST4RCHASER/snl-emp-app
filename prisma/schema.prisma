generator client {
  provider = "prisma-client"
  output   = "../packages/db/src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ENUMS ====================

enum Role {
  EMPLOYEE
  HR
  MANAGEMENT
  ADMIN
  DEVELOPER
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum ComplaintStatus {
  BACKLOG
  IN_PROGRESS
  DONE
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

// ==================== AUTH TABLES (Better Auth) ====================

model User {
  id            String  @id @default(cuid())
  email         String  @unique
  emailVerified Boolean @default(false)
  name          String?
  image         String?
  role          Role    @default(EMPLOYEE)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  banned     Boolean   @default(false)
  banReason  String?
  banExpires DateTime?

  sessions    Session[]
  accounts    Account[]
  employee    Employee?
  preferences UserPreferences?

  @@map("users")
}

// ==================== USER PREFERENCES ====================

model UserPreferences {
  id     String @id @default(cuid())
  userId String @unique

  theme             String  @default("system") // "system", "light", or "dark"
  accentColor       String  @default("#0078d4") // Hex color
  backgroundImage   String? // URL to background image
  backgroundFit     String  @default("cover") // "cover", "contain", "fill", "center"
  backgroundColor   String  @default("#1a1a1a") // Background color for fit modes
  guiScale          Float   @default(1.0) // GUI scaling factor 0.1 - 5.0
  desktopIconSize   Float   @default(1.0) // Desktop icon size multiplier
  taskbarSize       Float   @default(1.0) // Taskbar size multiplier
  appDrawerIconSize Float   @default(1.0) // App drawer icon size multiplier
  iconPositions     Json? // { appId: { x: number, y: number } }
  widgets           Json? // Array of widget objects
  desktopShortcuts  Json? // Array of app IDs shown on desktop

  // Virtual desktops and window state
  virtualDesktops Json? // Array of { id, name, order }
  activeDesktopId String? // Currently active desktop ID
  windowStates    Json? // Array of window state objects
  appSizes        Json? // { appId: { width, height } } - remembered window sizes

  // App-specific settings
  teamCalendarSettings         Json? // { showEvents, showWorkLogs, showReservations, viewMode }
  resourceReservationSettings  Json? // { viewMode, selectedResourceId, activeTab }
  leaveManagementSettings      Json? // { activeTab, pendingViewMode, allLeavesViewMode }

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_preferences")
}

model Session {
  id             String   @id @default(cuid())
  userId         String
  token          String   @unique
  expiresAt      DateTime
  ipAddress      String?
  userAgent      String?
  impersonatedBy String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model Account {
  id                    String    @id @default(cuid())
  userId                String
  accountId             String
  providerId            String
  accessToken           String?
  refreshToken          String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  idToken               String?
  password              String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("accounts")
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("verifications")
}

// ==================== EMPLOYEE TABLE ====================

model Employee {
  id         String @id @default(cuid())
  userId     String @unique
  employeeId String @unique // Company employee ID (e.g., EMP-001)

  // Personal Information (all optional as per requirements)
  fullName    String?
  nickname    String?
  avatar      String?
  phone       String?
  dateOfBirth DateTime?
  gender      Gender?

  // Address (optional)
  addressLine1 String?
  addressLine2 String?
  city         String?
  state        String?
  postalCode   String?
  country      String?

  // Employment Details (optional, HR-editable)
  department    String?
  position      String?
  salary        Decimal?  @db.Decimal(12, 2)
  hireDate      DateTime?
  startWorkDate DateTime? // Date employee started working (for leave eligibility)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user                  User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  managementLeads       EmployeeManagement[]   @relation("EmployeeToManagement")
  managedEmployees      EmployeeManagement[]   @relation("ManagementToEmployee")
  leaveRequests         LeaveRequest[]
  leaveApprovals        LeaveApproval[]
  complaints            Complaint[]
  workLogs              WorkLog[]
  employeeLeaveBalances EmployeeLeaveBalance[]

  // Resource Reservation relations
  resourceAsEmployee  ResourceReservation[] @relation("ResourceEmployee")
  resourceAsOwner     ResourceReservation[] @relation("ResourceOwner")
  resourceAsRequester ResourceReservation[] @relation("Requester")

  @@map("employees")
}

// ==================== EMPLOYEE-MANAGEMENT RELATIONSHIP ====================

model EmployeeManagement {
  id         String   @id @default(cuid())
  employeeId String
  managerId  String
  assignedAt DateTime @default(now())

  employee Employee @relation("EmployeeToManagement", fields: [employeeId], references: [id], onDelete: Cascade)
  manager  Employee @relation("ManagementToEmployee", fields: [managerId], references: [id], onDelete: Cascade)

  @@unique([employeeId, managerId])
  @@map("employee_management")
}

// ==================== LEAVE SYSTEM ====================

model LeaveRequest {
  id         String @id @default(cuid())
  employeeId String

  reason      String
  startDate   DateTime
  endDate     DateTime
  isHalfDay   Boolean  @default(false)
  halfDayType String? // "morning" or "afternoon" if isHalfDay

  status LeaveStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  employee          Employee        @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  approvals         LeaveApproval[]
  leaveTypeConfig   LeaveTypeConfig @relation("LeaveTypeConfigToRequest", fields: [leaveTypeConfigId], references: [id])
  leaveTypeConfigId String

  @@map("leave_requests")
}

model LeaveApproval {
  id             String @id @default(cuid())
  leaveRequestId String
  approverId     String

  approved    Boolean?
  comment     String?
  respondedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  leaveRequest LeaveRequest @relation(fields: [leaveRequestId], references: [id], onDelete: Cascade)
  approver     Employee     @relation(fields: [approverId], references: [id], onDelete: Cascade)

  @@unique([leaveRequestId, approverId])
  @@map("leave_approvals")
}

// ==================== GLOBAL SETTINGS ====================

model GlobalSettings {
  id String @id @default("global")

  // Leave quotas per year
  maxAnnualLeaveDays   Int @default(10)
  maxSickLeaveDays     Int @default(30)
  maxPersonalLeaveDays Int @default(7)
  maxBirthdayLeaveDays Int @default(1)

  // Annual leave carry-over settings
  annualLeaveCarryoverMax Int @default(3)

  // General settings
  maxConsecutiveLeaveDays Int @default(14)
  fiscalYearStartMonth    Int @default(1)

  // Work hours settings
  workHoursPerDay Float @default(8) // Standard work hours per day

  // Complaint settings
  complaintChatEnabled Boolean @default(true) // Enable/disable chat for complaints

  // Resource reservation settings
  reservationRequiresApproval Boolean @default(true) // Whether reservations need manager approval

  // Maintenance mode
  maintenanceMode    Boolean  @default(false) // When enabled, only DEV users can access
  maintenanceMessage String?  // Optional custom message to show during maintenance

  updatedAt DateTime @updatedAt

  @@map("global_settings")
}

// ==================== LEAVE TYPE CONFIGURATION ====================

model LeaveTypeConfig {
  id String @id @default(cuid())

  name        String // Display name (e.g., "Annual Leave", "Sick Leave")
  code        String  @unique // Unique code (e.g., "ANNUAL", "SICK", "CUSTOM_1")
  description String? // Optional description

  defaultBalance   Int     @default(0) // Default balance for all employees
  isUnlimited      Boolean @default(false) // If true, no balance tracking
  isPaid           Boolean @default(true) // Whether it's paid leave
  allowHalfDay     Boolean @default(true) // Whether half-day requests are allowed
  allowCarryover   Boolean @default(false) // Whether unused days can carry over
  carryoverMax     Int     @default(0) // Max days that can carry over
  requiresApproval Boolean @default(true) // Whether manager approval is required
  requiredWorkDays Int?    // Minimum work days required before employee can use this leave type
  allowedGender    Gender? // If set, only employees with this gender can use this leave type

  color    String? // Color for UI display (hex)
  icon     String? // Icon name for UI
  order    Int     @default(0) // Display order (lower = first)
  isActive Boolean @default(true) // Whether employees can use this leave type
  isDeleted Boolean @default(false) // Soft delete to hide from table but keep for logs

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  employeeBalances EmployeeLeaveBalance[]
  leaveRequests    LeaveRequest[]         @relation("LeaveTypeConfigToRequest")

  @@map("leave_type_configs")
}

model EmployeeLeaveBalance {
  id          String @id @default(cuid())
  employeeId  String
  leaveTypeId String

  // Custom balance for this employee (overrides default)
  balance     Int @default(0) // Total allocated days for this year
  used        Int @default(0) // Days already used (approved leaves)
  carriedOver Int @default(0) // Days carried from previous year
  adjustment  Int @default(0) // Manual adjustment (+/-) by HR

  year  Int // Fiscal year this balance applies to
  notes String? // HR notes for adjustments

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  employee  Employee        @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  leaveType LeaveTypeConfig @relation(fields: [leaveTypeId], references: [id], onDelete: Cascade)

  @@unique([employeeId, leaveTypeId, year])
  @@index([employeeId])
  @@index([leaveTypeId])
  @@index([year])
  @@map("employee_leave_balances")
}

// ==================== WORK LOG SYSTEM ====================

model WorkLog {
  id         String @id @default(cuid())
  employeeId String

  title       String
  description String?  @db.Text
  hours       Float // Hours worked (can be decimal like 1.5)
  date        DateTime @db.Date // The date of work

  // Who created this entry (for audit - manager can add for employee)
  createdById String

  // Soft delete
  isDeleted   Boolean   @default(false)
  deletedAt   DateTime?
  deletedById String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  employee  Employee       @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  auditLogs WorkLogAudit[]

  @@index([employeeId])
  @@index([date])
  @@index([employeeId, date])
  @@index([isDeleted])
  @@map("work_logs")
}

enum WorkLogAuditAction {
  CREATED
  UPDATED
  DELETED
}

model WorkLogAudit {
  id        String @id @default(cuid())
  workLogId String

  action   WorkLogAuditAction
  userId   String // Who performed the action
  userName String? // Cached name for display

  // Snapshot of changes (for updates)
  oldValues Json? // Previous values before change
  newValues Json? // New values after change

  createdAt DateTime @default(now())

  workLog WorkLog @relation(fields: [workLogId], references: [id], onDelete: Cascade)

  @@index([workLogId])
  @@index([userId])
  @@map("work_log_audits")
}

// ==================== COMPLAINT SYSTEM ====================

model Complaint {
  id         String @id @default(cuid())
  employeeId String

  subject     String
  description String          @db.Text
  status      ComplaintStatus @default(BACKLOG)
  isAnonymous Boolean         @default(true) // Whether the complaint is anonymous

  // HR Response (used when chat is disabled)
  hrResponse    String?   @db.Text
  hrRespondedBy String?
  hrRespondedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  employee Employee           @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  messages ComplaintMessage[]

  @@map("complaints")
}

model ComplaintMessage {
  id          String @id @default(cuid())
  complaintId String
  userId      String // The user who sent the message

  content  String  @db.Text
  isFromHR Boolean @default(false) // To identify HR messages vs employee messages

  // Attachment support (optional)
  attachmentUrl  String? // URL from m1r.ai
  attachmentName String? // Original filename
  attachmentType String? // MIME type (e.g., "image/png", "application/pdf")
  attachmentSize Int? // File size in bytes

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  complaint Complaint @relation(fields: [complaintId], references: [id], onDelete: Cascade)

  @@index([complaintId])
  @@map("complaint_messages")
}

// ==================== ANNOUNCEMENT SYSTEM ====================

model Announcement {
  id String @id @default(cuid())

  title   String
  content String @db.Text // Rich text / BBS style content
  images  Json? // Array of image URLs

  order     Int     @default(0) // For ordering (lower = higher priority)
  isActive  Boolean @default(true)
  createdBy String // User ID of HR who created

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  readReceipts AnnouncementRead[]

  @@map("announcements")
}

model AnnouncementRead {
  id             String @id @default(cuid())
  announcementId String
  userId         String

  readAt DateTime @default(now())

  announcement Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade)

  @@unique([announcementId, userId])
  @@map("announcement_reads")
}

// ==================== NOTES SYSTEM ====================

model Note {
  id     String @id @default(cuid())
  userId String

  title   String  @default("")
  content String  @db.Text // Rich text content (HTML)
  preview String? // Plain text preview for sidebar

  isPinned Boolean @default(false)
  isLocked Boolean @default(false) // Password protected
  lockHash String? // Hashed password for locked notes

  color String? // Background color for the note

  folderId String? // Optional folder organization

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  folder NoteFolder? @relation(fields: [folderId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([folderId])
  @@map("notes")
}

model NoteFolder {
  id     String @id @default(cuid())
  userId String

  name  String
  color String? // Folder color
  icon  String? // Folder icon

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  notes Note[]

  @@index([userId])
  @@map("note_folders")
}

// ==================== AUDIT LOG SYSTEM (Developer Only) ====================

model ActionLog {
  id     String  @id @default(cuid())
  userId String?

  // Action details
  action      String // e.g., "sign_in", "sign_out", "open_app", "click", "submit", "browse"
  category    String // e.g., "auth", "app", "navigation", "form"
  description String? // Human-readable description
  metadata    Json? // Additional context (app name, button clicked, etc.)

  // Client info
  ipAddress String?
  userAgent String?
  sessionId String?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([category])
  @@index([createdAt])
  @@map("action_logs")
}

model ApiLog {
  id     String  @id @default(cuid())
  userId String?

  // Request details
  method  String // GET, POST, PUT, DELETE, etc.
  path    String // API endpoint path
  query   Json? // Query parameters
  body    Json? // Request body (sanitized - no passwords)
  headers Json? // Request headers (sanitized)

  // Response details
  statusCode   Int
  responseTime Int // Response time in milliseconds
  responseSize Int? // Response size in bytes
  error        String? // Error message if any

  // Client info
  ipAddress String?
  userAgent String?
  sessionId String?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([method])
  @@index([path])
  @@index([statusCode])
  @@index([createdAt])
  @@map("api_logs")
}

// ==================== RESOURCE RESERVATION SYSTEM ====================

enum ReservationStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

model ResourceReservation {
  id String @id @default(cuid())

  // The employee being reserved (resource)
  resourceEmployeeId String
  // The manager who owns this employee (resource owner)
  resourceOwnerId    String
  // The manager requesting the reservation
  requesterId        String

  date        DateTime @db.Date // The date of reservation
  hours       Float // Number of hours requested (max from work hours settings)
  title       String // Name/title of the reservation
  description String?  @db.Text // Optional description

  status ReservationStatus @default(PENDING)

  // Approval details
  respondedAt DateTime?
  comment     String? // Response comment from resource owner

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  resourceEmployee Employee @relation("ResourceEmployee", fields: [resourceEmployeeId], references: [id], onDelete: Cascade)
  resourceOwner    Employee @relation("ResourceOwner", fields: [resourceOwnerId], references: [id], onDelete: Cascade)
  requester        Employee @relation("Requester", fields: [requesterId], references: [id], onDelete: Cascade)

  @@index([resourceEmployeeId])
  @@index([resourceOwnerId])
  @@index([requesterId])
  @@index([date])
  @@index([status])
  @@map("resource_reservations")
}
